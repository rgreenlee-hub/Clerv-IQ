<!-- Chatbot Widget - Add this to any page -->
<div id="chatbot-container">
  <!-- Chat Bubble Button -->
  <button id="chat-bubble" class="chat-bubble">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </button>

  <!-- Chat Window -->
  <div id="chat-window" class="chat-window hidden">
    <div class="chat-header">
      <div class="chat-header-content">
        <div class="chat-avatar">ü§ñ</div>
        <div>
          <h3>ClervIQ Assistant</h3>
          <p class="chat-status">Online ‚Ä¢ Typically replies instantly</p>
        </div>
      </div>
      <button id="close-chat" class="close-btn">√ó</button>
    </div>

    <div id="chat-messages" class="chat-messages">
      <div class="message bot-message">
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
          <p>Hi! I'm your ClervIQ assistant. How can I help you today?</p>
          <div class="quick-replies">
            <button class="quick-reply" data-message="Tell me about pricing">üí∞ Pricing</button>
            <button class="quick-reply" data-message="How does it work?">‚öôÔ∏è How it works</button>
            <button class="quick-reply" data-message="Schedule a demo">üìÖ Book Demo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type your message..." />
      <button id="send-btn" class="send-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
/* Chatbot Styles */
#chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: 'Courier Prime', monospace;
}

.chat-bubble {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #00d4ff, #0080ff);
  border: none;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 30px rgba(0, 212, 255, 0.6);
}

.chat-window {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 380px;
  height: 600px;
  background: rgba(20, 20, 20, 0.98);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.3s ease;
  border: 1px solid #00d4ff33;
}

.chat-window.hidden {
  display: none;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-header {
  background: linear-gradient(135deg, #00d4ff, #0080ff);
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-avatar {
  font-size: 24px;
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-header h3 {
  margin: 0;
  color: white;
  font-size: 16px;
  font-weight: bold;
}

.chat-status {
  margin: 0;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.8);
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: #0a0a0a;
}

.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #1a1a1a;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #00d4ff;
  border-radius: 3px;
}

.message {
  display: flex;
  gap: 10px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-avatar {
  font-size: 20px;
  width: 32px;
  height: 32px;
  flex-shrink: 0;
}

.message-content {
  flex: 1;
}

.message-content p {
  margin: 0;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.5;
}

.bot-message .message-content p {
  background: #1a1a1a;
  color: #eaeaea;
  border: 1px solid #333;
}

.user-message {
  flex-direction: row-reverse;
}

.user-message .message-content p {
  background: linear-gradient(135deg, #00d4ff, #0080ff);
  color: white;
  text-align: right;
}

.quick-replies {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}

.quick-reply {
  padding: 8px 12px;
  background: #1a1a1a;
  border: 1px solid #00d4ff;
  color: #00d4ff;
  border-radius: 20px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-reply:hover {
  background: #00d4ff;
  color: white;
}

.chat-input-container {
  padding: 16px;
  background: #1a1a1a;
  display: flex;
  gap: 8px;
  border-top: 1px solid #333;
}

#chat-input {
  flex: 1;
  padding: 12px 16px;
  background: #0a0a0a;
  border: 1px solid #333;
  border-radius: 24px;
  color: #eaeaea;
  font-size: 14px;
  font-family: 'Courier Prime', monospace;
  outline: none;
}

#chat-input:focus {
  border-color: #00d4ff;
}

.send-btn {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, #00d4ff, #0080ff);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

.send-btn:hover {
  transform: scale(1.1);
}

.send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
  background: #1a1a1a;
  border-radius: 12px;
  width: fit-content;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: #00d4ff;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: translateY(0);
  }
  30% {
    opacity: 1;
    transform: translateY(-10px);
  }
}

/* Mobile Responsive */
@media (max-width: 480px) {
  .chat-window {
    width: calc(100vw - 40px);
    height: calc(100vh - 120px);
    right: 20px;
    bottom: 90px;
  }
}
</style>

<script>
// Chatbot JavaScript
(function() {
  const chatBubble = document.getElementById('chat-bubble');
  const chatWindow = document.getElementById('chat-window');
  const closeChat = document.getElementById('close-chat');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const chatMessages = document.getElementById('chat-messages');

  let conversationHistory = [];
  let userName = null;
  let userEmail = null;

  // Toggle chat window
  chatBubble.addEventListener('click', () => {
    chatWindow.classList.remove('hidden');
    chatBubble.style.display = 'none';
    chatInput.focus();
  });

  closeChat.addEventListener('click', () => {
    chatWindow.classList.add('hidden');
    chatBubble.style.display = 'flex';
  });

  // Send message
  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Quick reply buttons
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('quick-reply')) {
      const message = e.target.getAttribute('data-message');
      chatInput.value = message;
      sendMessage();
    }
  });

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;

    // Show typing indicator
    showTypingIndicator();

    // Get page context
    const pageContext = getPageContext();

    try {
      // Send to backend
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          history: conversationHistory,
          context: pageContext,
          user_name: userName,
          user_email: userEmail
        }),
      });

      const data = await response.json();
      
      // Remove typing indicator
      removeTypingIndicator();

      if (data.success) {
        addMessage(data.reply, 'bot');
        
        // Check if bot is asking for contact info
        if (data.collect_lead) {
          setTimeout(() => {
            showLeadForm();
          }, 1000);
        }

        // Add quick replies if provided
        if (data.quick_replies && data.quick_replies.length > 0) {
          addQuickReplies(data.quick_replies);
        }
      } else {
        addMessage("I'm having trouble connecting. Please try again or contact us directly.", 'bot');
      }

    } catch (error) {
      console.error('Chat error:', error);
      removeTypingIndicator();
      addMessage("Sorry, I'm having technical difficulties. Please try again.", 'bot');
    }

    sendBtn.disabled = false;
    chatInput.focus();
  }

  function addMessage(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = type === 'bot' ? 'ü§ñ' : 'üë§';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const p = document.createElement('p');
    p.textContent = text;
    
    content.appendChild(p);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Store in history
    conversationHistory.push({ role: type, content: text });
  }

  function addQuickReplies(replies) {
    const lastBotMessage = document.querySelector('.bot-message:last-child .message-content');
    if (!lastBotMessage) return;

    const quickRepliesDiv = document.createElement('div');
    quickRepliesDiv.className = 'quick-replies';

    replies.forEach(reply => {
      const btn = document.createElement('button');
      btn.className = 'quick-reply';
      btn.setAttribute('data-message', reply);
      btn.textContent = reply;
      quickRepliesDiv.appendChild(btn);
    });

    lastBotMessage.appendChild(quickRepliesDiv);
  }

  function showTypingIndicator() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    messageDiv.id = 'typing-indicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = 'ü§ñ';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    
    content.appendChild(typingDiv);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
  }

  function getPageContext() {
    const path = window.location.pathname;
    const contexts = {
      '/': 'homepage',
      '/pricing': 'pricing_page',
      '/features': 'features_page',
      '/contact': 'contact_page',
      '/register': 'onboarding_page',
      '/dashboard': 'dashboard'
    };
    return contexts[path] || 'general';
  }

  function showLeadForm() {
    const formHTML = `
      <div class="message-content">
        <p>I'd love to help you further! Could you share your details?</p>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
          <input type="text" id="lead-name" placeholder="Your name" style="padding: 8px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #eaeaea;">
          <input type="email" id="lead-email" placeholder="Your email" style="padding: 8px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #eaeaea;">
          <button onclick="submitLead()" style="padding: 10px; background: linear-gradient(135deg, #00d4ff, #0080ff); border: none; border-radius: 8px; color: white; cursor: pointer;">Submit</button>
        </div>
      </div>
    `;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    messageDiv.innerHTML = `<div class="message-avatar">ü§ñ</div>${formHTML}`;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  window.submitLead = async function() {
    userName = document.getElementById('lead-name').value;
    userEmail = document.getElementById('lead-email').value;

    if (!userName || !userEmail) {
      alert('Please fill in both fields');
      return;
    }

    try {
      await fetch('/api/save-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: userName,
          email: userEmail,
          conversation: conversationHistory
        })
      });

      addMessage(`Thanks ${userName}! I've got your details. How else can I help you?`, 'bot');
    } catch (error) {
      console.error('Lead save error:', error);
    }
  };
})();
</script>