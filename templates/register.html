<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding | ClervIQ</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier Prime', monospace;
      background: linear-gradient(180deg, #0a0a0a, #111);
      color: #eaeaea;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .onboarding-container {
      background: rgba(20, 20, 20, 0.95);
      padding: 40px;
      border-radius: 20px;
      width: 600px;
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      text-align: center;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #00d4ff;
    }

    .progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .step {
      flex: 1;
      height: 6px;
      margin: 0 4px;
      border-radius: 5px;
      background: #333;
      transition: background 0.3s;
    }

    .step.active {
      background: linear-gradient(135deg, #00d4ff, #0080ff);
    }

    .onboarding-step {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .onboarding-step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }

    input, select {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: none;
      border-radius: 10px;
      background: #1a1a1a;
      color: #eaeaea;
      font-size: 16px;
    }

    button {
      padding: 14px 28px;
      margin-top: 20px;
      background: linear-gradient(135deg, #00d4ff, #0080ff);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    .review {
      text-align: left;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="onboarding-container">
    <h2>Welcome to Clerv IQ </h2>
    <div class="progress" id="progress"></div>

    <form method="POST" action="{{ url_for('onboarding') }}" id="onboardingForm">
      <!-- Step 1: Company Basics -->
      <div class="onboarding-step active">
        <p>What's your company name?</p>
        <input type="text" name="company" placeholder="e.g. Apex Dental Group">
        <p>Industry</p>
        <select name="industry">
          <option value="">Select industry</option>
          <option>Real Estate</option>
          <option>Dental / Med Spa</option>
          <option>Legal</option>
          <option>Finance</option>
          <option>Other</option>
        </select>
        <p>Number of Employees</p>
        <input type="number" name="employees" placeholder="e.g. 25">
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 2: Contact -->
      <div class="onboarding-step">
        <p>Preferred Contact Email</p>
        <input type="email" name="contact_email" placeholder="you@company.com">
        <p>Create Password</p>
        <input type="password" name="password" placeholder="Minimum 8 characters" minlength="8">
        <p>Confirm Password</p>
        <input type="password" name="confirm_password" placeholder="Re-enter password">
        <p>Preferred Contact Phone</p>
        <input type="tel" name="phone" placeholder="(123) 456-7890">
        <p>Preferred SMS Number</p>
        <input type="tel" name="sms" placeholder="(123) 456-7890">
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 3: Business Profile -->
      <div class="onboarding-step">
        <p>Annual Revenue</p>
        <input type="number" name="revenue" placeholder="$1,000,000">
        <p>Average Client Value</p>
        <input type="number" name="client_value" placeholder="$5000">
        <p>Average Monthly Leads</p>
        <input type="number" name="monthly_leads" placeholder="e.g. 100">
        <button type="button" onclick="nextStep()">Next</button>
      </div>

   <!-- Step 4: Operations -->
<div class="onboarding-step">
  <p>Office Location</p>
  <input type="text" name="location" placeholder="123 Main St, San Diego, CA">

  <p>Hours of Operation</p>
  <input type="text" name="hours" placeholder="Mon-Fri 9AM-5PM">

  <p>Company Website</p>
  <input type="url" name="website" placeholder="https://yourcompany.com">

  <p>Link to Online Calendar (Google/Outlook/Calendly)</p>
  <input type="url" name="calendar" placeholder="https://calendly.com/your-link">

  <p>Current CRM / Scheduling Tool</p>
  <select name="crm">
    <option value="">Select</option>
    <option>Salesforce</option>
    <option>GoHighLevel</option>
    <option>HubSpot</option>
    <option>None</option>
    <option>Other</option>
  </select>

  <button type="button" onclick="nextStep()">Next</button>
</div>

      <!-- Step 5: Goals -->
      <div class="onboarding-step">
        <p>Primary Goal</p>
        <select name="primary_goal">
          <option value="">Choose</option>
          <option>More Leads</option>
          <option>Better Follow-Up</option>
          <option>Reduce Missed Calls</option>
          <option>Increase Conversions</option>
          <option>Scale Operations</option>
        </select>
        <p>Secondary Goals</p>
        <input type="checkbox" name="goal_experience"> Improve Customer Experience<br>
        <input type="checkbox" name="goal_billing"> Automate Billing<br>
        <input type="checkbox" name="goal_marketing"> Expand Marketing<br>
        <input type="checkbox" name="goal_other"> Other<br>
        <p>Timeline</p>
        <select name="timeline">
          <option>1-3 months</option>
          <option>6 months</option>
          <option>12+ months</option>
        </select>
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 6: Preferences -->
      <div class="onboarding-step">
        <p>Communication Preference</p>
        <select name="communication">
          <option>Email</option>
          <option>SMS</option>
          <option>Phone</option>
          <option>All</option>
        </select>
        <p>Language Preference</p>
        <select name="language">
          <option>English</option>
          <option>Spanish</option>
          <option>Other</option>
        </select>
        <p>Support Level</p>
        <select name="support">
          <option>Standard</option>
          <option>Concierge</option>
          <option>White-Glove</option>
        </select>
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 7: Team -->
      <div class="onboarding-step">
        <p>Do you have a sales team?</p>
        <select name="sales_team">
          <option>Yes</option>
          <option>No</option>
        </select>
        <p>How many team members?</p>
        <input type="number" name="team_members" placeholder="e.g. 10">
        <p>Role assignment</p>
        <select name="roles">
          <option>Admin</option>
          <option>Reception</option>
          <option>Sales</option>
          <option>Billing</option>
        </select>
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 8: Integrations -->
      <div class="onboarding-step">
        <p>Do you need integrations?</p>
        <select name="integrations">
          <option>No</option>
          <option>Yes - Google Calendar</option>
          <option>Yes - Twilio</option>
          <option>Yes - Slack</option>
          <option>Yes - Stripe</option>
          <option>Yes - HubSpot</option>
        </select>
        <button type="button" onclick="nextStep()">Next</button>
      </div>

      <!-- Step 9: Compliance -->
      <div class="onboarding-step">
        <p>Compliance Requirements</p>
        <input type="checkbox" name="hipaa"> HIPAA<br>
        <input type="checkbox" name="gdpr"> GDPR<br>
        <input type="checkbox" name="ccpa"> CCPA<br>
        <input type="checkbox" name="none"> None<br>
        <p><input type="checkbox" name="consent"> I consent to SMS/Email communication</p>
        <button type="button" onclick="nextStep()">Next</button>
      </div>

<!-- Step 10: Host Phone Number -->
<div class="onboarding-step">
  <h3 style="color:#00d4ff; margin-bottom:20px;">üéôÔ∏è Host Your Phone Number</h3>
  <p>Enter your business phone number to enable AI answering.</p>
  
  <div id="phone-host-form">
    <input type="tel" id="phone-to-host" placeholder="+1 (555) 123-4567">
    <button type="button" onclick="hostPhoneNumber()">Send Verification Code</button>
  </div>
  
  <div id="otp-verification" style="display:none;">
    <p>We sent a verification code to your phone. Enter it below:</p>
    <input type="text" id="otp-code" placeholder="Enter 6-digit code" maxlength="6">
    <button type="button" onclick="verifyOTP()">Verify & Continue</button>
  </div>
  
  <p style="margin-top:20px; font-size:12px; color:#888;">
    <input type="checkbox" id="skip-phone"> Skip for now (you can add this later in dashboard)
  </p>
  <button type="button" onclick="skipPhoneHosting()" style="background:#555;">Skip This Step</button>
</div>

      <!-- Step 11: Review & Billing -->
    <div class="onboarding-step">
      <p>Review your details before continuing:</p>
      <div class="review" id="reviewBox"></div>

      <h3 style="margin-top:20px; color:#00d4ff;">Billing Information</h3>
      <p>Please enter your billing details to complete onboarding.</p>

      <!-- Full Stripe Billing Form -->
      <form id="payment-form">
        <!-- Contact Info -->
        <div class="form-row">
          <label for="billing-name">Full Name</label>
          <input type="text" id="billing-name" placeholder="John Doe">
        </div>

        <div class="form-row">
          <label for="billing-email">Email Address</label>
          <input type="email" id="billing-email" placeholder="john@company.com">
        </div>

        <div class="form-row">
          <label for="billing-company">Company Name</label>
          <input type="text" id="billing-company" placeholder="Apex Dental Group">
        </div>

        <!-- Address -->
        <div class="form-row">
          <label for="billing-address">Street Address</label>
          <input type="text" id="billing-address" placeholder="123 Main St">
        </div>

        <div class="form-row">
          <label for="billing-city">City</label>
          <input type="text" id="billing-city" placeholder="San Diego">
        </div>

        <div class="form-row">
          <label for="billing-state">State / Province</label>
          <input type="text" id="billing-state" placeholder="CA">
        </div>

        <div class="form-row">
          <label for="billing-zip">Postal / ZIP Code</label>
          <input type="text" id="billing-zip" placeholder="92101">
        </div>

        <div class="form-row">
          <label for="billing-country">Country</label>
          <input type="text" id="billing-country" placeholder="United States">
        </div>

        <!-- Card Info -->
        <div class="form-row">
          <label for="card-element">Credit or Debit Card</label>
          <div id="card-element"><!-- Stripe injects card UI here --></div>
        </div>

        <div id="card-errors" role="alert" style="color:#ff5555; margin-top:10px;"></div>

        <button id="submit" class="stripe-btn" type="submit">Pay & Go to Dashboard ‚Üí</button>
      </form>
    </div>
    </form>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    let currentStep = 0;
    let userData = {};
    const steps = document.querySelectorAll(".onboarding-step");
    const progressContainer = document.getElementById("progress");

    // Build progress dynamically
    steps.forEach((s, i) => {
      const bar = document.createElement("div");
      bar.classList.add("step");
      if (i === 0) bar.classList.add("active");
      progressContainer.appendChild(bar);
    });
    const progress = document.querySelectorAll(".step");

    function nextStep() {
      // Only validate inputs in the current step
      const currentStepElement = steps[currentStep];
      const requiredInputs = currentStepElement.querySelectorAll('[required]');
      
      // Check if all required fields in current step are filled
      for (let input of requiredInputs) {
        if (!input.value) {
          alert('Please fill in all required fields');
          return;
        }
      }
      
      // Collect data from current step
      const inputs = currentStepElement.querySelectorAll('input, select');
      inputs.forEach(input => {
        if (input.type === 'checkbox') {
          userData[input.name] = input.checked;
        } else {
          userData[input.name] = input.value;
        }
      });

      // Validate password match in step 2
      if (currentStep === 1) {
        const password = document.querySelector('input[name="password"]').value;
        const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
        if (password !== confirmPassword) {
          alert("Passwords do not match!");
          return;
        }
      }

      if (currentStep < steps.length - 1) {
        steps[currentStep].classList.remove("active");
        progress[currentStep].classList.remove("active");
        currentStep++;
        steps[currentStep].classList.add("active");
        progress[currentStep].classList.add("active");

        if (currentStep === steps.length - 1) {
          buildReview();
        }
      }
    }

    function buildReview() {
      const reviewBox = document.getElementById("reviewBox");
      reviewBox.innerHTML = "";
      for (let [key, value] of Object.entries(userData)) {
        if (value && key !== "password" && key !== "confirm_password") {
          reviewBox.innerHTML += `<p><strong>${key}:</strong> ${value}</p>`;
        }
      }
    }

    // === Initialize Stripe ===
    const stripe = Stripe("pk_live_51RxtOOELaAa23Of2t13jUdNz6fZXyFEUR2IqSvWAyzuztBGY2GcSKDXMTTXPFF7EmIDTrd4wp0gTXnMek2qqreGk000MMbbpJu");
    const elements = stripe.elements();

    // === Custom card element styling ===
    const style = {
      base: {
        color: "#eaeaea",
        fontSize: "16px",
        fontFamily: "'Courier Prime', monospace",
        fontSmoothing: "antialiased",
        "::placeholder": { color: "#888" }
      },
      invalid: { color: "#ff5555", iconColor: "#ff5555" }
    };

    // Mount card input
    const card = elements.create("card", { style });
    card.mount("#card-element");

    // === Handle form submission ===
    const paymentForm = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const errorBox = document.getElementById("card-errors");

    paymentForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Reset UI
      errorBox.textContent = "";
      submitBtn.disabled = true;
      submitBtn.textContent = "Processing...";

      // Collect billing details
      const billingDetails = {
        name: document.getElementById("billing-name")?.value || "",
        email: document.getElementById("billing-email")?.value || "",
        address: {
          line1: document.getElementById("billing-address")?.value || "",
          city: document.getElementById("billing-city")?.value || "",
          state: document.getElementById("billing-state")?.value || "",
          postal_code: document.getElementById("billing-zip")?.value || "",
          country: document.getElementById("billing-country")?.value || ""
        }
      };

      try {
        // 1. Create a PaymentMethod
        const { error, paymentMethod } = await stripe.createPaymentMethod({
          type: "card",
          card: card,
          billing_details: billingDetails,
        });

        if (error) {
          throw new Error(error.message);
        }

        // 2. Send to backend for Stripe payment processing
        const paymentResponse = await fetch("/charge", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            payment_method: paymentMethod.id,
            billing: billingDetails
          }),
        });

        const paymentResult = await paymentResponse.json();

        if (!paymentResult.success) {
          throw new Error(paymentResult.error || "Payment failed. Please try again.");
        }

        // 3. Payment successful - now create user account
        submitBtn.textContent = "Creating your account...";

        const registrationResponse = await fetch("/auth/complete-registration", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: userData.contact_email,
            password: userData.password,
            company_name: userData.company,
            industry: userData.industry,
            phone: userData.phone,
            onboarding_data: userData
          })
        });

        const registrationResult = await registrationResponse.json();

        if (!registrationResult.success) {
          throw new Error(registrationResult.error || "Failed to create account");
        }

        // 4. Success - redirect to dashboard
        submitBtn.textContent = "Complete! Redirecting...";
        setTimeout(() => {
          window.location.href = registrationResult.redirect || "/dashboard";
        }, 1000);

      } catch (err) {
        // Show error message
        errorBox.textContent = err.message;
        submitBtn.disabled = false;
        submitBtn.textContent = "Pay & Go to Dashboard ‚Üí";
      }
    });

    // Phone Number Hosting Functions
    async function hostPhoneNumber() {
      const phoneInput = document.getElementById('phone-to-host');
      const phone = phoneInput.value.trim();
      
      if (!phone) {
        alert('Please enter a phone number');
        return;
      }
      
      // Disable button while processing
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Sending code...';
      
      try {
        const response = await fetch('/onboarding/host-number', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({phone_number: phone})
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (result.skip_otp) {
            // No OTP needed, just continue
            alert(result.message);
            nextStep();
          } else {
            // Show OTP verification
            document.getElementById('phone-host-form').style.display = 'none';
            document.getElementById('otp-verification').style.display = 'block';
            alert('‚úÖ ' + result.message);
          }
        } else {
          alert('Error: ' + result.error + '\n\nYou can skip this step and we\'ll set it up manually.');
          btn.disabled = false;
          btn.textContent = 'Send Verification Code';
        }
      } catch (err) {
        console.error('Phone verification error:', err);
        alert('Could not send verification. Click "Skip This Step" to continue.');
        btn.disabled = false;
        btn.textContent = 'Send Verification Code';
      }
    }

    async function verifyOTP() {
      const otpInput = document.getElementById('otp-code');
      const otp = otpInput.value.trim();
      
      if (!otp || otp.length !== 6) {
        alert('Please enter the 6-digit code');
        return;
      }
      
      // Disable button while processing
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      
      try {
        const response = await fetch('/onboarding/verify-otp', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({otp_code: otp})
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Phone verified successfully!');
          nextStep();
        } else {
          alert('‚ùå ' + (result.error || 'Invalid code. Please try again.'));
          btn.disabled = false;
          btn.textContent = 'Verify & Continue';
          otpInput.value = '';
          otpInput.focus();
        }
      } catch (err) {
        console.error('OTP verification error:', err);
        alert('Verification error. Please try again or skip this step.');
        btn.disabled = false;
        btn.textContent = 'Verify & Continue';
      }
    }

    function skipPhoneHosting() {
      const skipCheckbox = document.getElementById('skip-phone');
      if (skipCheckbox.checked || confirm('Skip phone hosting for now? You can add this later in your dashboard.')) {
        nextStep();
      }
    }

     </script>

<!-- Chatbot Widget -->
{% include 'chatbot_widget.html' %}
</body>
</html>